# 企业级小程序项目实战开发指南

> 本文档总结了大厂企业级项目中使用 Vue2/Vue3/Vue3+TS/React(Taro) 开发微信小程序和钉钉小程序的所有知识点、最佳实践和实战经验。


<div class="doc-toc">

## 目录
1. [企业级项目架构设计](#1-企业级项目架构设计)
2. [代码规范与工程化](#2-代码规范与工程化)
3. [权限与登录体系](#3-权限与登录体系)
4. [网络请求最佳实践](#4-网络请求最佳实践)
5. [状态管理最佳实践](#5-状态管理最佳实践)
6. [组件库设计与封装](#6-组件库设计与封装)
7. [表单处理最佳实践](#7-表单处理最佳实践)
8. [列表与分页最佳实践](#8-列表与分页最佳实践)
9. [性能优化实战](#9-性能优化实战)
10. [多端适配实战](#10-多端适配实战)
11. [错误处理与监控](#11-错误处理与监控)
12. [安全最佳实践](#12-安全最佳实践)
13. [测试策略](#13-测试策略)
14. [CI/CD与发布流程](#14-cicd与发布流程)
15. [实战案例：电商小程序](#15-实战案例电商小程序)
16. [实战案例：企业OA小程序](#16-实战案例企业oa小程序)


</div>

---

## 1. 企业级项目架构设计

### 1.1 目录结构规范

```
├── src/
│   ├── api/                    # API接口模块
│   │   ├── modules/            # 按业务模块划分
│   │   │   ├── user.ts
│   │   │   ├── product.ts
│   │   │   ├── order.ts
│   │   │   └── index.ts
│   │   ├── request.ts          # 请求封装
│   │   └── index.ts            # 统一导出
│   │
│   ├── components/             # 公共组件
│   │   ├── base/               # 基础组件
│   │   │   ├── Button/
│   │   │   ├── Input/
│   │   │   ├── Modal/
│   │   │   └── index.ts
│   │   ├── business/           # 业务组件
│   │   │   ├── ProductCard/
│   │   │   ├── OrderItem/
│   │   │   └── index.ts
│   │   └── layout/             # 布局组件
│   │       ├── NavBar/
│   │       ├── TabBar/
│   │       └── index.ts
│   │
│   ├── composables/            # Vue3组合式函数 / React Hooks
│   │   ├── useRequest.ts
│   │   ├── usePagination.ts
│   │   ├── useAuth.ts
│   │   ├── useForm.ts
│   │   └── index.ts
│   │
│   ├── stores/                 # 状态管理
│   │   ├── modules/
│   │   │   ├── user.ts
│   │   │   ├── cart.ts
│   │   │   └── app.ts
│   │   └── index.ts
│   │
│   ├── pages/                  # 页面
│   │   ├── index/              # 首页
│   │   ├── user/               # 用户中心
│   │   ├── product/            # 商品模块
│   │   │   ├── list/
│   │   │   └── detail/
│   │   ├── order/              # 订单模块
│   │   │   ├── list/
│   │   │   ├── detail/
│   │   │   └── create/
│   │   └── login/              # 登录
│   │
│   ├── packageA/               # 分包A
│   │   └── pages/
│   ├── packageB/               # 分包B
│   │   └── pages/
│   │
│   ├── types/                  # 类型定义
│   │   ├── api.d.ts
│   │   ├── store.d.ts
│   │   ├── components.d.ts
│   │   └── index.d.ts
│   │
│   ├── utils/                  # 工具函数
│   │   ├── request.ts
│   │   ├── storage.ts
│   │   ├── validator.ts
│   │   ├── format.ts
│   │   ├── platform.ts
│   │   └── index.ts
│   │
│   ├── constants/              # 常量定义
│   │   ├── api.ts
│   │   ├── storage.ts
│   │   └── index.ts
│   │
│   ├── styles/                 # 全局样式
│   │   ├── variables.scss
│   │   ├── mixins.scss
│   │   └── common.scss
│   │
│   ├── static/                 # 静态资源
│   │   ├── images/
│   │   ├── icons/
│   │   └── tabbar/
│   │
│   ├── App.vue                 # 应用入口
│   ├── main.ts                 # 主入口
│   ├── manifest.json           # 应用配置
│   ├── pages.json              # 页面配置
│   └── uni.scss                # 全局样式变量
│
├── config/                     # 项目配置
│   ├── env.development.ts
│   ├── env.production.ts
│   └── index.ts
│
├── scripts/                    # 构建脚本
├── tests/                      # 测试文件
├── .eslintrc.js               # ESLint配置
├── .prettierrc                # Prettier配置
├── tsconfig.json              # TypeScript配置
└── package.json
```

### 1.2 分层架构设计

```
┌─────────────────────────────────────────────────────────┐
│                       页面层 (Pages)                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  负责页面渲染、用户交互、调用业务逻辑                    │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                      组件层 (Components)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 基础组件  │  │ 业务组件  │  │ 布局组件  │              │
│  └──────────┘  └──────────┘  └──────────┘              │
├─────────────────────────────────────────────────────────┤
│                     业务逻辑层 (Composables/Hooks)        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ useAuth  │  │ useCart  │  │ useOrder │              │
│  └──────────┘  └──────────┘  └──────────┘              │
├─────────────────────────────────────────────────────────┤
│                      状态管理层 (Store)                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ userStore │  │ cartStore │  │ appStore │              │
│  └──────────┘  └──────────┘  └──────────┘              │
├─────────────────────────────────────────────────────────┤
│                      数据请求层 (API)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │  userApi  │  │ productApi│  │ orderApi │              │
│  └──────────┘  └──────────┘  └──────────┘              │
├─────────────────────────────────────────────────────────┤
│                      基础设施层 (Utils)                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ request  │  │ storage  │  │ platform │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

### 1.3 模块化设计原则

```typescript
// 1. 单一职责原则：每个模块只负责一个功能
// api/modules/user.ts - 只处理用户相关API
export const userApi = {
  login: (data) => http.post('/user/login', data),
  getInfo: () => http.get('/user/info'),
  updateInfo: (data) => http.put('/user/info', data)
}

// 2. 开放封闭原则：对扩展开放，对修改封闭
// 使用策略模式处理多端登录
const loginStrategies = {
  weixin: () => wxLogin(),
  dingtalk: () => dingLogin(),
  phone: (data) => phoneLogin(data)
}

export const login = (type: keyof typeof loginStrategies, data?: any) => {
  return loginStrategies[type](data)
}

// 3. 依赖倒置原则：依赖抽象而非具体实现
// 定义存储接口
interface IStorage {
  get<T>(key: string): T | null
  set<T>(key: string, value: T): void
  remove(key: string): void
}

// UniApp实现
class UniStorage implements IStorage {
  get<T>(key: string): T | null {
    return uni.getStorageSync(key) || null
  }
  set<T>(key: string, value: T): void {
    uni.setStorageSync(key, value)
  }
  remove(key: string): void {
    uni.removeStorageSync(key)
  }
}
```

---

## 2. 代码规范与工程化

### 2.1 ESLint配置

```javascript
// .eslintrc.js
module.exports = {
  root: true,
  env: {
    node: true,
    'vue/setup-compiler-macros': true
  },
  extends: [
    'plugin:vue/vue3-recommended',
    '@vue/typescript/recommended',
    'prettier'
  ],
  parserOptions: {
    ecmaVersion: 2020
  },
  rules: {
    'no-console': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    'no-debugger': process.env.NODE_ENV === 'production' ? 'warn' : 'off',
    '@typescript-eslint/no-explicit-any': 'off',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    'vue/multi-word-component-names': 'off',
    'vue/no-v-html': 'off',
    // 自定义规则
    'vue/component-name-in-template-casing': ['error', 'PascalCase'],
    'vue/prop-name-casing': ['error', 'camelCase'],
    'vue/require-default-prop': 'error',
    'vue/require-prop-types': 'error'
  },
  globals: {
    uni: 'readonly',
    wx: 'readonly',
    dd: 'readonly',
    getCurrentPages: 'readonly'
  }
}
```

### 2.2 Prettier配置

```json
// .prettierrc
{
  "semi": false,
  "singleQuote": true,
  "trailingComma": "none",
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "bracketSpacing": true,
  "arrowParens": "avoid",
  "endOfLine": "auto"
}
```

### 2.3 Git提交规范

```bash
# commitlint.config.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat',     // 新功能
        'fix',      // 修复Bug
        'docs',     // 文档更新
        'style',    // 代码格式（不影响功能）
        'refactor', // 重构
        'perf',     // 性能优化
        'test',     // 测试
        'chore',    // 构建/工具
        'revert',   // 回滚
        'build'     // 构建相关
      ]
    ],
    'subject-case': [0]
  }
}

# 提交示例
git commit -m "feat(user): 添加微信登录功能"
git commit -m "fix(cart): 修复购物车数量计算错误"
git commit -m "perf(list): 优化列表渲染性能"
```

### 2.4 Husky配置

```json
// package.json
{
  "scripts": {
    "prepare": "husky install",
    "lint": "eslint --ext .vue,.ts,.tsx src/",
    "lint:fix": "eslint --ext .vue,.ts,.tsx src/ --fix",
    "format": "prettier --write src/"
  },
  "lint-staged": {
    "*.{vue,ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ]
  }
}
```

```bash
# .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx lint-staged

# .husky/commit-msg
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx --no-install commitlint --edit "$1"
```

---

## 3. 权限与登录体系

### 3.1 统一登录架构

```typescript
// composables/useAuth.ts (Vue3) 或 hooks/useAuth.ts (React)
import { ref, computed } from 'vue'
import { useUserStore } from '@/stores/user'
import { platformLogin, getPlatform } from '@/utils/platform'
import { userApi } from '@/api'
import router from '@/utils/router'

export function useAuth() {
  const userStore = useUserStore()
  const loading = ref(false)
  
  const isLogin = computed(() => userStore.isLogin)
  const userInfo = computed(() => userStore.userInfo)
  
  // 统一登录入口
  const login = async (type: 'auto' | 'phone' | 'password', data?: any) => {
    loading.value = true
    
    try {
      let result
      
      if (type === 'auto') {
        // 自动登录（根据平台）
        const platform = getPlatform()
        const { code } = await platformLogin()
        
        result = await userApi.platformLogin({
          platform,
          code,
          ...data
        })
      } else if (type === 'phone') {
        // 手机号登录
        result = await userApi.phoneLogin(data)
      } else if (type === 'password') {
        // 账号密码登录
        result = await userApi.passwordLogin(data)
      }
      
      if (result) {
        userStore.setToken(result.token)
        userStore.setUserInfo(result.userInfo)
        
        // 处理登录后跳转
        handleLoginSuccess()
      }
      
      return result
    } catch (error) {
      console.error('登录失败:', error)
      throw error
    } finally {
      loading.value = false
    }
  }
  
  // 登录成功后处理
  const handleLoginSuccess = () => {
    // 获取重定向地址
    const pages = getCurrentPages()
    const currentPage = pages[pages.length - 1]
    const redirect = currentPage?.options?.redirect
    
    if (redirect) {
      router.replace(decodeURIComponent(redirect))
    } else {
      router.switchTab('/pages/index/index')
    }
  }
  
  // 检查登录状态
  const checkLogin = (options?: { silent?: boolean; redirect?: string }) => {
    if (!isLogin.value) {
      if (!options?.silent) {
        uni.showToast({ title: '请先登录', icon: 'none' })
      }
      
      const redirectUrl = options?.redirect || getCurrentPageUrl()
      router.push(`/pages/login/index?redirect=${encodeURIComponent(redirectUrl)}`)
      return false
    }
    return true
  }
  
  // 需要登录的操作装饰器
  const requireLogin = <T extends (...args: any[]) => any>(fn: T): T => {
    return ((...args: Parameters<T>) => {
      if (checkLogin()) {
        return fn(...args)
      }
    }) as T
  }
  
  // 退出登录
  const logout = () => {
    uni.showModal({
      title: '提示',
      content: '确定要退出登录吗？',
      success: (res) => {
        if (res.confirm) {
          userStore.logout()
        }
      }
    })
  }
  
  // 刷新Token
  const refreshToken = async () => {
    try {
      const refreshToken = userStore.refreshToken
      if (!refreshToken) {
        throw new Error('No refresh token')
      }
      
      const result = await userApi.refreshToken({ refreshToken })
      userStore.setToken(result.token)
      
      return result.token
    } catch (error) {
      userStore.logout()
      throw error
    }
  }
  
  return {
    loading,
    isLogin,
    userInfo,
    login,
    logout,
    checkLogin,
    requireLogin,
    refreshToken
  }
}

// 获取当前页面URL
function getCurrentPageUrl(): string {
  const pages = getCurrentPages()
  const currentPage = pages[pages.length - 1]
  if (!currentPage) return ''
  
  const route = currentPage.route || ''
  const options = currentPage.options || {}
  const query = Object.keys(options)
    .map(key => `${key}=${options[key]}`)
    .join('&')
  
  return query ? `/${route}?${query}` : `/${route}`
}
```

### 3.2 路由权限控制

```typescript
// utils/router.ts
const WHITE_LIST = ['/pages/index/index', '/pages/login/index']
const NEED_LOGIN_PAGES = ['/pages/user/index', '/pages/order/list']

class Router {
  private checkPermission(url: string): boolean {
    const path = url.split('?')[0]
    
    // 白名单直接通过
    if (WHITE_LIST.includes(path)) {
      return true
    }
    
    // 需要登录的页面
    if (NEED_LOGIN_PAGES.includes(path)) {
      const token = uni.getStorageSync('token')
      if (!token) {
        uni.showToast({ title: '请先登录', icon: 'none' })
        this.push(`/pages/login/index?redirect=${encodeURIComponent(url)}`)
        return false
      }
    }
    
    return true
  }
  
  push(url: string, options?: UniApp.NavigateToOptions) {
    if (!this.checkPermission(url)) return
    return uni.navigateTo({ url, ...options })
  }
  
  replace(url: string) {
    if (!this.checkPermission(url)) return
    return uni.redirectTo({ url })
  }
  
  switchTab(url: string) {
    return uni.switchTab({ url })
  }
  
  reLaunch(url: string) {
    return uni.reLaunch({ url })
  }
  
  back(delta = 1) {
    return uni.navigateBack({ delta })
  }
}

export default new Router()
```

### 3.3 微信小程序登录流程

```typescript
// 微信小程序完整登录流程
async function wxLoginFlow() {
  // 1. 调用wx.login获取code
  const loginRes = await new Promise<UniApp.LoginRes>((resolve, reject) => {
    uni.login({
      provider: 'weixin',
      success: resolve,
      fail: reject
    })
  })
  
  // 2. 发送code到后端换取session
  const sessionRes = await userApi.wxLogin({ code: loginRes.code })
  
  // 3. 如果需要手机号，引导用户授权
  if (sessionRes.needPhone) {
    // 显示手机号授权按钮
    return { needPhone: true, tempToken: sessionRes.tempToken }
  }
  
  // 4. 登录成功
  return sessionRes
}

// 获取手机号（button组件回调）
async function handleGetPhoneNumber(e: any, tempToken: string) {
  if (e.detail.errMsg !== 'getPhoneNumber:ok') {
    uni.showToast({ title: '需要授权手机号', icon: 'none' })
    return
  }
  
  // 发送手机号code到后端
  const result = await userApi.bindPhone({
    code: e.detail.code,
    tempToken
  })
  
  return result
}
```

### 3.4 钉钉小程序登录流程

```typescript
// 钉钉小程序免登流程
async function dingLoginFlow() {
  // 1. 获取免登授权码
  const authCode = await new Promise<string>((resolve, reject) => {
    // @ts-ignore
    dd.getAuthCode({
      success: (res: any) => resolve(res.authCode),
      fail: reject
    })
  })
  
  // 2. 发送authCode到后端
  const result = await userApi.dingLogin({ authCode })
  
  // 3. 后端使用authCode调用钉钉API获取用户信息
  return result
}
```

---

## 4. 网络请求最佳实践

### 4.1 请求封装（企业级）

```typescript
// utils/request.ts
import { useUserStore } from '@/stores/user'

// 配置
const config = {
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000,
  retryCount: 3,
  retryDelay: 1000
}

// 请求队列（用于token刷新时暂存请求）
let isRefreshing = false
let requestQueue: Array<{
  resolve: (token: string) => void
  reject: (error: any) => void
}> = []

// 请求拦截器
function requestInterceptor(options: RequestOptions): RequestOptions {
  const userStore = useUserStore()
  
  // 添加公共请求头
  options.header = {
    'Content-Type': 'application/json',
    'X-Platform': getPlatform(),
    'X-Version': getAppVersion(),
    'X-Request-Id': generateRequestId(),
    ...options.header
  }
  
  // 添加Token
  if (userStore.token) {
    options.header.Authorization = `Bearer ${userStore.token}`
  }
  
  // 添加签名（可选）
  if (options.sign !== false) {
    options.header['X-Sign'] = generateSign(options)
  }
  
  return options
}

// 响应拦截器
async function responseInterceptor<T>(
  response: UniApp.RequestSuccessCallbackResult,
  options: RequestOptions
): Promise<T> {
  const { statusCode, data } = response
  const result = data as ApiResponse<T>
  
  // HTTP状态码处理
  if (statusCode >= 200 && statusCode < 300) {
    // 业务状态码处理
    switch (result.code) {
      case 0:
      case 200:
        return result.data
        
      case 401:
        // Token过期
        return handleTokenExpired<T>(options)
        
      case 403:
        uni.showToast({ title: '没有权限', icon: 'none' })
        throw new ApiError(result.code, result.message)
        
      case 500:
        uni.showToast({ title: '服务器错误', icon: 'none' })
        throw new ApiError(result.code, result.message)
        
      default:
        uni.showToast({ title: result.message || '请求失败', icon: 'none' })
        throw new ApiError(result.code, result.message)
    }
  }
  
  // HTTP错误
  throw new HttpError(statusCode, `HTTP Error: ${statusCode}`)
}

// 处理Token过期
async function handleTokenExpired<T>(options: RequestOptions): Promise<T> {
  const userStore = useUserStore()
  
  if (!isRefreshing) {
    isRefreshing = true
    
    try {
      // 尝试刷新Token
      const refreshToken = uni.getStorageSync('refreshToken')
      if (!refreshToken) {
        throw new Error('No refresh token')
      }
      
      const result = await userApi.refreshToken({ refreshToken })
      userStore.setToken(result.token)
      
      // 处理等待队列
      requestQueue.forEach(({ resolve }) => resolve(result.token))
      requestQueue = []
      
      // 重试当前请求
      options.header!.Authorization = `Bearer ${result.token}`
      return request<T>(options)
      
    } catch (error) {
      // 刷新失败，跳转登录
      requestQueue.forEach(({ reject }) => reject(error))
      requestQueue = []
      
      userStore.logout()
      throw error
      
    } finally {
      isRefreshing = false
    }
  } else {
    // 等待Token刷新完成
    return new Promise<T>((resolve, reject) => {
      requestQueue.push({
        resolve: (token) => {
          options.header!.Authorization = `Bearer ${token}`
          resolve(request<T>(options))
        },
        reject
      })
    })
  }
}

// 主请求函数
async function request<T = any>(options: RequestOptions): Promise<T> {
  // 应用请求拦截器
  const finalOptions = requestInterceptor({
    ...options,
    url: options.url.startsWith('http') 
      ? options.url 
      : config.baseURL + options.url
  })
  
  // 显示Loading
  if (options.loading !== false) {
    uni.showLoading({
      title: options.loadingText || '加载中...',
      mask: true
    })
  }
  
  try {
    // 发起请求
    const response = await new Promise<UniApp.RequestSuccessCallbackResult>(
      (resolve, reject) => {
        const requestTask = uni.request({
          url: finalOptions.url,
          method: finalOptions.method || 'GET',
          data: finalOptions.data,
          header: finalOptions.header,
          timeout: finalOptions.timeout || config.timeout,
          success: resolve,
          fail: reject
        })
        
        // 支持取消请求
        if (options.cancelToken) {
          options.cancelToken.promise.then(() => {
            requestTask.abort()
          })
        }
      }
    )
    
    // 应用响应拦截器
    return responseInterceptor<T>(response, options)
    
  } catch (error) {
    // 网络错误重试
    if (isNetworkError(error) && (options.retryCount ?? config.retryCount) > 0) {
      await delay(config.retryDelay)
      return request<T>({
        ...options,
        retryCount: (options.retryCount ?? config.retryCount) - 1
      })
    }
    
    uni.showToast({ title: '网络请求失败', icon: 'none' })
    throw error
    
  } finally {
    if (options.loading !== false) {
      uni.hideLoading()
    }
  }
}

// 快捷方法
export const http = {
  get: <T = any>(url: string, params?: any, options?: Partial<RequestOptions>) =>
    request<T>({ url, method: 'GET', data: params, ...options }),
    
  post: <T = any>(url: string, data?: any, options?: Partial<RequestOptions>) =>
    request<T>({ url, method: 'POST', data, ...options }),
    
  put: <T = any>(url: string, data?: any, options?: Partial<RequestOptions>) =>
    request<T>({ url, method: 'PUT', data, ...options }),
    
  delete: <T = any>(url: string, data?: any, options?: Partial<RequestOptions>) =>
    request<T>({ url, method: 'DELETE', data, ...options }),
    
  upload: <T = any>(url: string, filePath: string, options?: UploadOptions) =>
    uploadFile<T>(url, filePath, options)
}

// 类型定义
interface RequestOptions {
  url: string
  method?: 'GET' | 'POST' | 'PUT' | 'DELETE'
  data?: any
  header?: Record<string, string>
  timeout?: number
  loading?: boolean
  loadingText?: string
  sign?: boolean
  retryCount?: number
  cancelToken?: CancelToken
}

class ApiError extends Error {
  constructor(public code: number, message: string) {
    super(message)
    this.name = 'ApiError'
  }
}

class HttpError extends Error {
  constructor(public statusCode: number, message: string) {
    super(message)
    this.name = 'HttpError'
  }
}

// 取消Token
class CancelToken {
  promise: Promise<void>
  private resolve!: () => void
  
  constructor() {
    this.promise = new Promise(resolve => {
      this.resolve = resolve
    })
  }
  
  cancel() {
    this.resolve()
  }
}

export { CancelToken }
export default request
```

### 4.2 API模块化

```typescript
// api/modules/user.ts
import http from '@/utils/request'
import type { 
  LoginParams, 
  LoginResult, 
  UserInfo,
  PhoneLoginParams 
} from '@/types/api'

export const userApi = {
  // 平台登录
  platformLogin: (data: { platform: string; code: string }) =>
    http.post<LoginResult>('/auth/platform-login', data),
  
  // 手机号登录
  phoneLogin: (data: PhoneLoginParams) =>
    http.post<LoginResult>('/auth/phone-login', data),
  
  // 密码登录
  passwordLogin: (data: { username: string; password: string }) =>
    http.post<LoginResult>('/auth/password-login', data),
  
  // 微信登录
  wxLogin: (data: { code: string }) =>
    http.post<LoginResult>('/auth/wx-login', data),
  
  // 钉钉登录
  dingLogin: (data: { authCode: string }) =>
    http.post<LoginResult>('/auth/ding-login', data),
  
  // 绑定手机号
  bindPhone: (data: { code: string; tempToken: string }) =>
    http.post<LoginResult>('/auth/bind-phone', data),
  
  // 刷新Token
  refreshToken: (data: { refreshToken: string }) =>
    http.post<{ token: string }>('/auth/refresh-token', data),
  
  // 获取用户信息
  getInfo: () =>
    http.get<UserInfo>('/user/info'),
  
  // 更新用户信息
  updateInfo: (data: Partial<UserInfo>) =>
    http.put<UserInfo>('/user/info', data),
  
  // 发送验证码
  sendCode: (data: { phone: string; type: string }) =>
    http.post('/sms/send', data, { loading: false }),
  
  // 验证码校验
  verifyCode: (data: { phone: string; code: string }) =>
    http.post<{ valid: boolean }>('/sms/verify', data)
}

// api/modules/product.ts
import http from '@/utils/request'
import type { Product, ProductListParams, PaginatedData } from '@/types/api'

export const productApi = {
  // 获取商品列表
  getList: (params: ProductListParams) =>
    http.get<PaginatedData<Product>>('/product/list', params),
  
  // 获取商品详情
  getDetail: (id: number) =>
    http.get<Product>(`/product/${id}`, undefined, { loading: false }),
  
  // 搜索商品
  search: (keyword: string, params?: Omit<ProductListParams, 'keyword'>) =>
    http.get<PaginatedData<Product>>('/product/search', { keyword, ...params }),
  
  // 获取推荐商品
  getRecommend: (productId: number, limit = 10) =>
    http.get<Product[]>('/product/recommend', { productId, limit }),
  
  // 获取商品分类
  getCategories: () =>
    http.get<Category[]>('/product/categories')
}

// api/index.ts - 统一导出
export * from './modules/user'
export * from './modules/product'
export * from './modules/order'
export * from './modules/cart'
```

---

## 5. 状态管理最佳实践

### 5.1 Vue3 Pinia Store设计

```typescript
// stores/modules/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { UserInfo } from '@/types'
import { userApi } from '@/api'
import { storage } from '@/utils/storage'

export const useUserStore = defineStore('user', () => {
  // === State ===
  const token = ref(storage.get<string>('token') || '')
  const refreshToken = ref(storage.get<string>('refreshToken') || '')
  const userInfo = ref<UserInfo | null>(storage.get<UserInfo>('userInfo'))
  
  // === Getters ===
  const isLogin = computed(() => !!token.value)
  const userName = computed(() => userInfo.value?.name || '未登录')
  const userId = computed(() => userInfo.value?.id)
  const avatar = computed(() => userInfo.value?.avatar || '/static/default-avatar.png')
  
  // === Actions ===
  const setToken = (newToken: string, newRefreshToken?: string) => {
    token.value = newToken
    storage.set('token', newToken)
    
    if (newRefreshToken) {
      refreshToken.value = newRefreshToken
      storage.set('refreshToken', newRefreshToken)
    }
  }
  
  const setUserInfo = (info: UserInfo | null) => {
    userInfo.value = info
    if (info) {
      storage.set('userInfo', info)
    } else {
      storage.remove('userInfo')
    }
  }
  
  const login = async (loginType: string, data?: any) => {
    let result
    
    switch (loginType) {
      case 'wx':
        result = await userApi.wxLogin(data)
        break
      case 'ding':
        result = await userApi.dingLogin(data)
        break
      case 'phone':
        result = await userApi.phoneLogin(data)
        break
      default:
        throw new Error('Unknown login type')
    }
    
    setToken(result.token, result.refreshToken)
    setUserInfo(result.userInfo)
    
    return result
  }
  
  const getUserInfo = async () => {
    if (!token.value) return null
    
    const info = await userApi.getInfo()
    setUserInfo(info)
    return info
  }
  
  const logout = () => {
    token.value = ''
    refreshToken.value = ''
    userInfo.value = null
    
    storage.remove('token')
    storage.remove('refreshToken')
    storage.remove('userInfo')
    
    uni.reLaunch({ url: '/pages/login/index' })
  }
  
  return {
    // State
    token,
    refreshToken,
    userInfo,
    // Getters
    isLogin,
    userName,
    userId,
    avatar,
    // Actions
    setToken,
    setUserInfo,
    login,
    getUserInfo,
    logout
  }
})

// stores/modules/cart.ts
import { defineStore } from 'pinia'
import { ref, computed, watch } from 'vue'
import type { CartItem, Product } from '@/types'
import { storage } from '@/utils/storage'
import { cartApi } from '@/api'

export const useCartStore = defineStore('cart', () => {
  // === State ===
  const items = ref<CartItem[]>(storage.get<CartItem[]>('cart') || [])
  const syncing = ref(false)
  
  // === Getters ===
  const count = computed(() => 
    items.value.reduce((sum, item) => sum + item.count, 0)
  )
  
  const selectedItems = computed(() => 
    items.value.filter(item => item.selected)
  )
  
  const totalPrice = computed(() => 
    selectedItems.value.reduce((sum, item) => sum + item.price * item.count, 0)
  )
  
  const isAllSelected = computed(() => 
    items.value.length > 0 && items.value.every(item => item.selected)
  )
  
  const isEmpty = computed(() => items.value.length === 0)
  
  // === Actions ===
  const addItem = async (product: Product, count = 1, specs?: string) => {
    const existItem = items.value.find(
      item => item.productId === product.id && item.specs === specs
    )
    
    if (existItem) {
      existItem.count += count
    } else {
      items.value.push({
        id: Date.now(),
        productId: product.id,
        name: product.name,
        image: product.image,
        price: product.price,
        count,
        specs,
        selected: true,
        stock: product.stock
      })
    }
    
    await syncToServer()
    uni.showToast({ title: '已加入购物车', icon: 'success' })
  }
  
  const removeItem = async (itemId: number) => {
    const index = items.value.findIndex(item => item.id === itemId)
    if (index > -1) {
      items.value.splice(index, 1)
      await syncToServer()
    }
  }
  
  const updateCount = async (itemId: number, count: number) => {
    const item = items.value.find(item => item.id === itemId)
    if (item) {
      if (count <= 0) {
        await removeItem(itemId)
      } else if (count > item.stock) {
        uni.showToast({ title: '超出库存', icon: 'none' })
      } else {
        item.count = count
        await syncToServer()
      }
    }
  }
  
  const toggleSelect = (itemId: number) => {
    const item = items.value.find(item => item.id === itemId)
    if (item) {
      item.selected = !item.selected
      saveToLocal()
    }
  }
  
  const toggleSelectAll = () => {
    const newValue = !isAllSelected.value
    items.value.forEach(item => {
      item.selected = newValue
    })
    saveToLocal()
  }
  
  const clear = async () => {
    items.value = []
    await syncToServer()
  }
  
  const clearSelected = async () => {
    items.value = items.value.filter(item => !item.selected)
    await syncToServer()
  }
  
  // 同步到服务器
  const syncToServer = async () => {
    if (syncing.value) return
    
    syncing.value = true
    try {
      await cartApi.sync(items.value)
      saveToLocal()
    } catch (error) {
      console.error('同步购物车失败:', error)
    } finally {
      syncing.value = false
    }
  }
  
  // 从服务器获取
  const fetchFromServer = async () => {
    try {
      const serverItems = await cartApi.getList()
      items.value = serverItems
      saveToLocal()
    } catch (error) {
      console.error('获取购物车失败:', error)
    }
  }
  
  // 保存到本地
  const saveToLocal = () => {
    storage.set('cart', items.value)
  }
  
  return {
    // State
    items,
    syncing,
    // Getters
    count,
    selectedItems,
    totalPrice,
    isAllSelected,
    isEmpty,
    // Actions
    addItem,
    removeItem,
    updateCount,
    toggleSelect,
    toggleSelectAll,
    clear,
    clearSelected,
    fetchFromServer
  }
})
```

### 5.2 Store持久化

```typescript
// plugins/piniaPersist.ts
import type { PiniaPluginContext } from 'pinia'
import { storage } from '@/utils/storage'

interface PersistOptions {
  key?: string
  paths?: string[]
}

declare module 'pinia' {
  export interface DefineStoreOptionsBase<S, Store> {
    persist?: boolean | PersistOptions
  }
}

export function piniaPlugin({ store, options }: PiniaPluginContext) {
  if (!options.persist) return
  
  const persistOptions = typeof options.persist === 'object' 
    ? options.persist 
    : {}
  
  const key = persistOptions.key || `pinia-${store.$id}`
  const paths = persistOptions.paths
  
  // 从存储中恢复状态
  const savedState = storage.get<Record<string, any>>(key)
  if (savedState) {
    store.$patch(savedState)
  }
  
  // 监听状态变化并保存
  store.$subscribe((mutation, state) => {
    const toSave = paths 
      ? paths.reduce((acc, path) => {
          acc[path] = state[path]
          return acc
        }, {} as Record<string, any>)
      : state
    
    storage.set(key, toSave)
  }, { detached: true })
}

// main.ts中使用
import { createPinia } from 'pinia'
import { piniaPlugin } from '@/plugins/piniaPersist'

const pinia = createPinia()
pinia.use(piniaPlugin)
```

---

## 6. 组件库设计与封装

### 6.1 基础组件封装

```vue
<!-- components/base/Button/Button.vue -->
<template>
  <button
    :class="[
      'custom-button',
      `custom-button--${type}`,
      `custom-button--${size}`,
      {
        'custom-button--block': block,
        'custom-button--round': round,
        'custom-button--plain': plain,
        'custom-button--disabled': disabled,
        'custom-button--loading': loading
      }
    ]"
    :disabled="disabled || loading"
    :open-type="openType"
    @click="handleClick"
    @getphonenumber="handleGetPhoneNumber"
  >
    <view v-if="loading" class="custom-button__loading">
      <text class="iconfont icon-loading"></text>
    </view>
    <view v-if="icon && !loading" class="custom-button__icon">
      <text :class="['iconfont', `icon-${icon}`]"></text>
    </view>
    <view class="custom-button__text">
      <slot></slot>
    </view>
  </button>
</template>

<script setup lang="ts">
import type { ButtonProps } from '@/types/components'

const props = withDefaults(defineProps<ButtonProps>(), {
  type: 'default',
  size: 'medium',
  block: false,
  round: false,
  plain: false,
  disabled: false,
  loading: false
})

const emit = defineEmits<{
  click: [event: Event]
  getphonenumber: [event: any]
}>()

const handleClick = (e: Event) => {
  if (props.disabled || props.loading) return
  emit('click', e)
}

const handleGetPhoneNumber = (e: any) => {
  emit('getphonenumber', e)
}
</script>

<style lang="scss">
.custom-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 32rpx;
  border: none;
  border-radius: 8rpx;
  font-size: 28rpx;
  transition: all 0.2s;
  
  &--primary {
    background-color: $primary-color;
    color: #fff;
  }
  
  &--default {
    background-color: #fff;
    color: #333;
    border: 1rpx solid #ddd;
  }
  
  &--danger {
    background-color: $danger-color;
    color: #fff;
  }
  
  &--large {
    height: 96rpx;
    font-size: 32rpx;
  }
  
  &--medium {
    height: 80rpx;
  }
  
  &--small {
    height: 64rpx;
    padding: 0 24rpx;
    font-size: 24rpx;
  }
  
  &--block {
    width: 100%;
  }
  
  &--round {
    border-radius: 999rpx;
  }
  
  &--plain {
    background-color: transparent;
    
    &.custom-button--primary {
      color: $primary-color;
      border: 1rpx solid $primary-color;
    }
  }
  
  &--disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  &--loading {
    .custom-button__loading {
      margin-right: 8rpx;
      animation: rotate 1s linear infinite;
    }
  }
  
  &__icon {
    margin-right: 8rpx;
  }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
```

### 6.2 业务组件封装

```vue
<!-- components/business/ProductCard/ProductCard.vue -->
<template>
  <view 
    class="product-card" 
    :class="{ 'product-card--horizontal': layout === 'horizontal' }"
    @click="handleClick"
  >
    <view class="product-card__image-wrapper">
      <image 
        class="product-card__image" 
        :src="product.image" 
        mode="aspectFill"
        lazy-load
        @error="handleImageError"
      />
      <!-- 标签 -->
      <view v-if="product.tags?.length" class="product-card__tags">
        <text 
          v-for="tag in product.tags.slice(0, 2)" 
          :key="tag"
          class="product-card__tag"
        >
          {{ tag }}
        </text>
      </view>
      <!-- 售罄蒙层 -->
      <view v-if="product.stock === 0" class="product-card__sold-out">
        <text>已售罄</text>
      </view>
    </view>
    
    <view class="product-card__content">
      <text class="product-card__name">{{ product.name }}</text>
      
      <text v-if="showDesc && product.description" class="product-card__desc">
        {{ product.description }}
      </text>
      
      <view class="product-card__footer">
        <view class="product-card__price">
          <text class="product-card__price-current">
            <text class="product-card__price-symbol">¥</text>
            {{ formatPrice(product.price) }}
          </text>
          <text v-if="product.originalPrice" class="product-card__price-original">
            ¥{{ formatPrice(product.originalPrice) }}
          </text>
        </view>
        
        <view v-if="showSales" class="product-card__sales">
          已售{{ formatSales(product.sales) }}
        </view>
      </view>
      
      <!-- 操作按钮插槽 -->
      <view class="product-card__actions" @click.stop>
        <slot name="actions">
          <CustomButton 
            v-if="showCartBtn" 
            size="small" 
            type="primary"
            :disabled="product.stock === 0"
            @click="handleAddCart"
          >
            加购
          </CustomButton>
        </slot>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import type { Product } from '@/types'
import CustomButton from '@/components/base/Button/Button.vue'

interface Props {
  product: Product
  layout?: 'vertical' | 'horizontal'
  showDesc?: boolean
  showSales?: boolean
  showCartBtn?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  layout: 'vertical',
  showDesc: false,
  showSales: true,
  showCartBtn: true
})

const emit = defineEmits<{
  click: [product: Product]
  addCart: [product: Product]
}>()

// 格式化价格
const formatPrice = (price: number): string => {
  return price.toFixed(2)
}

// 格式化销量
const formatSales = (sales: number): string => {
  if (sales >= 10000) {
    return (sales / 10000).toFixed(1) + '万'
  }
  return sales.toString()
}

// 点击商品
const handleClick = () => {
  emit('click', props.product)
}

// 加入购物车
const handleAddCart = () => {
  emit('addCart', props.product)
}

// 图片加载失败
const handleImageError = (e: any) => {
  // 设置默认图片
  e.target.src = '/static/images/default-product.png'
}
</script>

<style lang="scss">
.product-card {
  background-color: #fff;
  border-radius: 16rpx;
  overflow: hidden;
  
  &--horizontal {
    display: flex;
    
    .product-card__image-wrapper {
      width: 240rpx;
      height: 240rpx;
      flex-shrink: 0;
    }
    
    .product-card__content {
      flex: 1;
      padding: 20rpx;
    }
  }
  
  &__image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%;
  }
  
  &__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
  
  &__tags {
    position: absolute;
    top: 16rpx;
    left: 16rpx;
    display: flex;
    gap: 8rpx;
  }
  
  &__tag {
    padding: 4rpx 12rpx;
    background-color: $primary-color;
    color: #fff;
    font-size: 20rpx;
    border-radius: 4rpx;
  }
  
  &__sold-out {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 28rpx;
  }
  
  &__content {
    padding: 16rpx;
  }
  
  &__name {
    font-size: 28rpx;
    color: #333;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  &__desc {
    margin-top: 8rpx;
    font-size: 24rpx;
    color: #999;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  &__footer {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-top: 16rpx;
  }
  
  &__price {
    display: flex;
    align-items: baseline;
  }
  
  &__price-current {
    font-size: 36rpx;
    color: $danger-color;
    font-weight: bold;
  }
  
  &__price-symbol {
    font-size: 24rpx;
  }
  
  &__price-original {
    margin-left: 8rpx;
    font-size: 24rpx;
    color: #999;
    text-decoration: line-through;
  }
  
  &__sales {
    font-size: 22rpx;
    color: #999;
  }
  
  &__actions {
    margin-top: 16rpx;
  }
}
</style>
```

---

## 7. 表单处理最佳实践

### 7.1 表单验证Hook

```typescript
// composables/useForm.ts
import { reactive, ref, computed, watch } from 'vue'
import type { UnwrapRef } from 'vue'

// 验证规则类型
type Validator<T = any> = (value: T, formData: Record<string, any>) => boolean | string | Promise<boolean | string>

interface Rule<T = any> {
  required?: boolean
  message?: string
  pattern?: RegExp
  min?: number
  max?: number
  validator?: Validator<T>
  trigger?: 'blur' | 'change' | 'submit'
}

type Rules<T extends Record<string, any>> = {
  [K in keyof T]?: Rule<T[K]> | Rule<T[K]>[]
}

interface UseFormOptions<T extends Record<string, any>> {
  initialValues: T
  rules?: Rules<T>
  validateOnChange?: boolean
}

// 内置验证器
const validators = {
  required: (value: any) => {
    if (Array.isArray(value)) return value.length > 0
    if (typeof value === 'string') return value.trim().length > 0
    return value !== null && value !== undefined
  },
  
  phone: (value: string) => /^1[3-9]\d{9}$/.test(value),
  
  email: (value: string) => /^[\w.-]+@[\w.-]+\.\w+$/.test(value),
  
  idCard: (value: string) => /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(value),
  
  url: (value: string) => /^https?:\/\/[\w.-]+/.test(value)
}

export function useForm<T extends Record<string, any>>(options: UseFormOptions<T>) {
  const { initialValues, rules = {}, validateOnChange = false } = options
  
  // 表单数据
  const form = reactive<T>({ ...initialValues })
  
  // 错误信息
  const errors = reactive<Record<keyof T, string>>(
    Object.keys(initialValues).reduce((acc, key) => {
      acc[key as keyof T] = ''
      return acc
    }, {} as Record<keyof T, string>)
  )
  
  // 触摸状态（用于判断是否显示错误）
  const touched = reactive<Record<keyof T, boolean>>(
    Object.keys(initialValues).reduce((acc, key) => {
      acc[key as keyof T] = false
      return acc
    }, {} as Record<keyof T, boolean>)
  )
  
  // 提交状态
  const submitting = ref(false)
  
  // 是否有错误
  const hasError = computed(() => 
    Object.values(errors).some(error => !!error)
  )
  
  // 是否可提交
  const canSubmit = computed(() => 
    !hasError.value && !submitting.value
  )
  
  // 验证单个字段
  const validateField = async (field: keyof T): Promise<boolean> => {
    const fieldRules = rules[field]
    if (!fieldRules) return true
    
    const value = form[field]
    const ruleList = Array.isArray(fieldRules) ? fieldRules : [fieldRules]
    
    for (const rule of ruleList) {
      // required
      if (rule.required && !validators.required(value)) {
        errors[field] = rule.message || `${String(field)}不能为空`
        return false
      }
      
      // pattern
      if (rule.pattern && !rule.pattern.test(String(value))) {
        errors[field] = rule.message || `${String(field)}格式不正确`
        return false
      }
      
      // min
      if (rule.min !== undefined) {
        const len = typeof value === 'string' ? value.length : Number(value)
        if (len < rule.min) {
          errors[field] = rule.message || `${String(field)}至少${rule.min}个字符`
          return false
        }
      }
      
      // max
      if (rule.max !== undefined) {
        const len = typeof value === 'string' ? value.length : Number(value)
        if (len > rule.max) {
          errors[field] = rule.message || `${String(field)}最多${rule.max}个字符`
          return false
        }
      }
      
      // 自定义验证器
      if (rule.validator) {
        const result = await rule.validator(value, form as Record<string, any>)
        if (result !== true) {
          errors[field] = typeof result === 'string' ? result : rule.message || '验证失败'
          return false
        }
      }
    }
    
    errors[field] = ''
    return true
  }
  
  // 验证所有字段
  const validate = async (): Promise<boolean> => {
    const fields = Object.keys(rules) as (keyof T)[]
    const results = await Promise.all(fields.map(validateField))
    return results.every(r => r)
  }
  
  // 设置字段触摸状态
  const setTouched = (field: keyof T) => {
    touched[field] = true
    validateField(field)
  }
  
  // 重置表单
  const reset = () => {
    Object.keys(form).forEach(key => {
      (form as Record<string, any>)[key] = initialValues[key as keyof T]
    })
    Object.keys(errors).forEach(key => {
      (errors as Record<string, string>)[key] = ''
    })
    Object.keys(touched).forEach(key => {
      (touched as Record<string, boolean>)[key] = false
    })
  }
  
  // 设置表单值
  const setValues = (values: Partial<T>) => {
    Object.keys(values).forEach(key => {
      if (key in form) {
        (form as Record<string, any>)[key] = values[key as keyof T]
      }
    })
  }
  
  // 设置字段值
  const setFieldValue = <K extends keyof T>(field: K, value: T[K]) => {
    (form as Record<string, any>)[field] = value
  }
  
  // 设置错误
  const setError = (field: keyof T, message: string) => {
    errors[field] = message
  }
  
  // 清除错误
  const clearErrors = (fields?: (keyof T)[]) => {
    const keys = fields || (Object.keys(errors) as (keyof T)[])
    keys.forEach(key => {
      errors[key] = ''
    })
  }
  
  // 提交表单
  const submit = async (handler: (data: T) => Promise<void>) => {
    // 标记所有字段为已触摸
    Object.keys(touched).forEach(key => {
      (touched as Record<string, boolean>)[key] = true
    })
    
    // 验证
    const valid = await validate()
    if (!valid) {
      const firstError = Object.values(errors).find(e => e)
      if (firstError) {
        uni.showToast({ title: firstError, icon: 'none' })
      }
      return false
    }
    
    // 提交
    submitting.value = true
    try {
      await handler(form as T)
      return true
    } catch (error) {
      console.error('提交失败:', error)
      return false
    } finally {
      submitting.value = false
    }
  }
  
  // 监听字段变化自动验证
  if (validateOnChange) {
    Object.keys(rules).forEach(field => {
      watch(
        () => form[field as keyof T],
        () => {
          if (touched[field as keyof T]) {
            validateField(field as keyof T)
          }
        }
      )
    })
  }
  
  return {
    form,
    errors,
    touched,
    submitting,
    hasError,
    canSubmit,
    validateField,
    validate,
    setTouched,
    reset,
    setValues,
    setFieldValue,
    setError,
    clearErrors,
    submit
  }
}
```

### 7.2 表单组件使用

```vue
<!-- pages/register/index.vue -->
<template>
  <view class="register-page">
    <view class="form">
      <FormItem 
        label="手机号" 
        :error="touched.phone ? errors.phone : ''"
        required
      >
        <input
          v-model="form.phone"
          type="number"
          maxlength="11"
          placeholder="请输入手机号"
          @blur="setTouched('phone')"
        />
      </FormItem>
      
      <FormItem 
        label="验证码" 
        :error="touched.code ? errors.code : ''"
        required
      >
        <view class="code-input">
          <input
            v-model="form.code"
            type="number"
            maxlength="6"
            placeholder="请输入验证码"
            @blur="setTouched('code')"
          />
          <CustomButton 
            size="small" 
            :disabled="!canSendCode || isCounting"
            @click="handleSendCode"
          >
            {{ isCounting ? `${seconds}s` : '获取验证码' }}
          </CustomButton>
        </view>
      </FormItem>
      
      <FormItem 
        label="密码" 
        :error="touched.password ? errors.password : ''"
        required
      >
        <input
          v-model="form.password"
          type="password"
          placeholder="请输入密码（6-20位）"
          @blur="setTouched('password')"
        />
      </FormItem>
      
      <FormItem 
        label="确认密码" 
        :error="touched.confirmPassword ? errors.confirmPassword : ''"
        required
      >
        <input
          v-model="form.confirmPassword"
          type="password"
          placeholder="请再次输入密码"
          @blur="setTouched('confirmPassword')"
        />
      </FormItem>
      
      <view class="agreement">
        <checkbox 
          :checked="form.agreement" 
          @click="form.agreement = !form.agreement"
        />
        <text>我已阅读并同意</text>
        <text class="link" @click="goToAgreement">《用户协议》</text>
      </view>
      
      <CustomButton 
        type="primary" 
        block 
        :loading="submitting"
        :disabled="!form.agreement"
        @click="handleSubmit"
      >
        注册
      </CustomButton>
    </view>
  </view>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useForm } from '@/composables/useForm'
import { useCountdown } from '@/composables/useCountdown'
import { userApi } from '@/api'
import FormItem from '@/components/base/FormItem/FormItem.vue'
import CustomButton from '@/components/base/Button/Button.vue'

interface RegisterForm {
  phone: string
  code: string
  password: string
  confirmPassword: string
  agreement: boolean
}

const {
  form,
  errors,
  touched,
  submitting,
  validateField,
  setTouched,
  submit
} = useForm<RegisterForm>({
  initialValues: {
    phone: '',
    code: '',
    password: '',
    confirmPassword: '',
    agreement: false
  },
  rules: {
    phone: [
      { required: true, message: '请输入手机号' },
      { pattern: /^1[3-9]\d{9}$/, message: '手机号格式不正确' }
    ],
    code: [
      { required: true, message: '请输入验证码' },
      { pattern: /^\d{6}$/, message: '验证码为6位数字' }
    ],
    password: [
      { required: true, message: '请输入密码' },
      { min: 6, max: 20, message: '密码长度为6-20位' }
    ],
    confirmPassword: [
      { required: true, message: '请确认密码' },
      {
        validator: (value, formData) => 
          value === formData.password || '两次密码输入不一致'
      }
    ]
  },
  validateOnChange: true
})

// 倒计时
const { seconds, isCounting, start } = useCountdown(60)

// 是否可以发送验证码
const canSendCode = computed(() => 
  /^1[3-9]\d{9}$/.test(form.phone) && !isCounting.value
)

// 发送验证码
const handleSendCode = async () => {
  if (!canSendCode.value) return
  
  try {
    await userApi.sendCode({ phone: form.phone, type: 'register' })
    uni.showToast({ title: '验证码已发送', icon: 'success' })
    start()
  } catch (error) {
    console.error('发送验证码失败:', error)
  }
}

// 提交注册
const handleSubmit = () => {
  submit(async (data) => {
    await userApi.register({
      phone: data.phone,
      code: data.code,
      password: data.password
    })
    
    uni.showToast({ title: '注册成功', icon: 'success' })
    
    setTimeout(() => {
      uni.navigateTo({ url: '/pages/login/index' })
    }, 1500)
  })
}

// 跳转用户协议
const goToAgreement = () => {
  uni.navigateTo({ url: '/pages/agreement/index' })
}
</script>
```

---

## 8. 列表与分页最佳实践

### 8.1 通用分页Hook

```typescript
// composables/usePagination.ts
import { ref, computed, watch } from 'vue'
import type { Ref, ComputedRef } from 'vue'

interface PaginationOptions<T, P extends Record<string, any>> {
  fetchFn: (params: P & { page: number; pageSize: number }) => Promise<{
    list: T[]
    total: number
  }>
  pageSize?: number
  defaultParams?: P
  immediate?: boolean
  cacheKey?: string
}

interface PaginationReturn<T, P> {
  list: Ref<T[]>
  loading: Ref<boolean>
  refreshing: Ref<boolean>
  finished: Ref<boolean>
  error: Ref<Error | null>
  page: Ref<number>
  total: Ref<number>
  hasMore: ComputedRef<boolean>
  isEmpty: ComputedRef<boolean>
  
  loadData: (refresh?: boolean) => Promise<void>
  refresh: () => Promise<void>
  loadMore: () => Promise<void>
  setParams: (params: Partial<P>) => void
  reset: () => void
}

export function usePagination<T, P extends Record<string, any> = {}>(
  options: PaginationOptions<T, P>
): PaginationReturn<T, P> {
  const {
    fetchFn,
    pageSize = 10,
    defaultParams = {} as P,
    immediate = false,
    cacheKey
  } = options
  
  // 状态
  const list = ref<T[]>([]) as Ref<T[]>
  const loading = ref(false)
  const refreshing = ref(false)
  const finished = ref(false)
  const error = ref<Error | null>(null)
  const page = ref(1)
  const total = ref(0)
  const params = ref<P>({ ...defaultParams }) as Ref<P>
  
  // 计算属性
  const hasMore = computed(() => !finished.value && !loading.value)
  const isEmpty = computed(() => !loading.value && list.value.length === 0)
  
  // 加载数据
  const loadData = async (refresh = false): Promise<void> => {
    if (loading.value) return
    if (finished.value && !refresh) return
    
    loading.value = true
    refreshing.value = refresh
    error.value = null
    
    if (refresh) {
      page.value = 1
      finished.value = false
    }
    
    try {
      const res = await fetchFn({
        ...params.value,
        page: page.value,
        pageSize
      })
      
      const items = res.list || []
      total.value = res.total || 0
      
      if (refresh) {
        list.value = items
      } else {
        list.value = [...list.value, ...items]
      }
      
      if (items.length < pageSize) {
        finished.value = true
      } else {
        page.value++
      }
      
      // 缓存数据
      if (cacheKey && refresh) {
        try {
          uni.setStorageSync(cacheKey, {
            list: list.value,
            total: total.value,
            timestamp: Date.now()
          })
        } catch (e) {
          console.warn('缓存数据失败:', e)
        }
      }
      
    } catch (err) {
      error.value = err instanceof Error ? err : new Error(String(err))
      throw err
    } finally {
      loading.value = false
      refreshing.value = false
      uni.stopPullDownRefresh()
    }
  }
  
  // 刷新
  const refresh = () => loadData(true)
  
  // 加载更多
  const loadMore = () => loadData(false)
  
  // 设置参数
  const setParams = (newParams: Partial<P>) => {
    params.value = { ...params.value, ...newParams }
    refresh()
  }
  
  // 重置
  const reset = () => {
    list.value = []
    page.value = 1
    total.value = 0
    finished.value = false
    error.value = null
    params.value = { ...defaultParams }
  }
  
  // 从缓存恢复
  if (cacheKey) {
    try {
      const cached = uni.getStorageSync(cacheKey)
      if (cached && Date.now() - cached.timestamp < 5 * 60 * 1000) {
        list.value = cached.list
        total.value = cached.total
      }
    } catch (e) {
      console.warn('读取缓存失败:', e)
    }
  }
  
  // 立即加载
  if (immediate) {
    refresh()
  }
  
  return {
    list,
    loading,
    refreshing,
    finished,
    error,
    page,
    total,
    hasMore,
    isEmpty,
    loadData,
    refresh,
    loadMore,
    setParams,
    reset
  }
}
```

### 8.2 列表页面组件

```vue
<!-- pages/product/list/index.vue -->
<template>
  <view class="product-list-page">
    <!-- 搜索栏 -->
    <view class="search-bar">
      <input
        v-model="searchKey"
        placeholder="搜索商品"
        confirm-type="search"
        @confirm="handleSearch"
      />
      <text class="search-btn" @click="handleSearch">搜索</text>
    </view>
    
    <!-- 筛选栏 -->
    <view class="filter-bar">
      <view 
        v-for="item in sortOptions" 
        :key="item.value"
        :class="['filter-item', { active: sortBy === item.value }]"
        @click="handleSort(item.value)"
      >
        {{ item.label }}
        <text v-if="item.value === sortBy" class="arrow">
          {{ sortOrder === 'asc' ? '↑' : '↓' }}
        </text>
      </view>
    </view>
    
    <!-- 商品列表 -->
    <scroll-view
      scroll-y
      class="product-list"
      :refresher-enabled="true"
      :refresher-triggered="refreshing"
      @refresherrefresh="handleRefresh"
      @scrolltolower="handleLoadMore"
    >
      <!-- 骨架屏 -->
      <template v-if="loading && list.length === 0">
        <ProductSkeleton v-for="i in 6" :key="i" />
      </template>
      
      <!-- 商品列表 -->
      <template v-else>
        <view class="product-grid">
          <ProductCard
            v-for="item in list"
            :key="item.id"
            :product="item"
            @click="goDetail"
            @add-cart="handleAddCart"
          />
        </view>
        
        <!-- 加载状态 -->
        <view class="load-status">
          <text v-if="loading">加载中...</text>
          <text v-else-if="finished && list.length > 0">没有更多了</text>
        </view>
      </template>
      
      <!-- 空状态 -->
      <Empty v-if="isEmpty" text="暂无商品" />
      
      <!-- 错误状态 -->
      <view v-if="error" class="error-state">
        <text>加载失败</text>
        <CustomButton size="small" @click="refresh">重试</CustomButton>
      </view>
    </scroll-view>
    
    <!-- 返回顶部 -->
    <view 
      v-show="showBackTop" 
      class="back-top"
      @click="scrollToTop"
    >
      <text class="iconfont icon-top"></text>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { onLoad, onPullDownRefresh, onReachBottom, onPageScroll } from '@dcloudio/uni-app'
import { usePagination } from '@/composables/usePagination'
import { useCartStore } from '@/stores/cart'
import { productApi } from '@/api'
import type { Product } from '@/types'
import ProductCard from '@/components/business/ProductCard/ProductCard.vue'
import ProductSkeleton from '@/components/business/ProductCard/ProductSkeleton.vue'
import Empty from '@/components/base/Empty/Empty.vue'
import CustomButton from '@/components/base/Button/Button.vue'

// 搜索关键词
const searchKey = ref('')

// 排序
const sortBy = ref('default')
const sortOrder = ref<'asc' | 'desc'>('desc')

const sortOptions = [
  { label: '综合', value: 'default' },
  { label: '销量', value: 'sales' },
  { label: '价格', value: 'price' },
  { label: '新品', value: 'created' }
]

// 分页数据
const {
  list,
  loading,
  refreshing,
  finished,
  error,
  isEmpty,
  refresh,
  loadMore,
  setParams
} = usePagination<Product, { keyword?: string; sortBy?: string; sortOrder?: string }>({
  fetchFn: productApi.getList,
  pageSize: 10,
  immediate: false,
  cacheKey: 'product_list_cache'
})

// 购物车
const cartStore = useCartStore()

// 返回顶部
const showBackTop = ref(false)

// 页面加载
onLoad((options) => {
  if (options?.keyword) {
    searchKey.value = options.keyword
  }
  if (options?.categoryId) {
    setParams({ categoryId: Number(options.categoryId) })
  } else {
    refresh()
  }
})

// 下拉刷新
onPullDownRefresh(() => {
  refresh()
})

// 触底加载
onReachBottom(() => {
  loadMore()
})

// 页面滚动
onPageScroll((e) => {
  showBackTop.value = e.scrollTop > 500
})

// 搜索
const handleSearch = () => {
  setParams({ keyword: searchKey.value })
}

// 排序
const handleSort = (value: string) => {
  if (sortBy.value === value) {
    sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc'
  } else {
    sortBy.value = value
    sortOrder.value = 'desc'
  }
  setParams({ sortBy: sortBy.value, sortOrder: sortOrder.value })
}

// 下拉刷新
const handleRefresh = () => {
  refresh()
}

// 加载更多
const handleLoadMore = () => {
  if (!loading.value && !finished.value) {
    loadMore()
  }
}

// 跳转详情
const goDetail = (product: Product) => {
  uni.navigateTo({
    url: `/pages/product/detail/index?id=${product.id}`
  })
}

// 加入购物车
const handleAddCart = async (product: Product) => {
  await cartStore.addItem(product)
}

// 返回顶部
const scrollToTop = () => {
  uni.pageScrollTo({
    scrollTop: 0,
    duration: 300
  })
}
</script>

<style lang="scss">
.product-list-page {
  min-height: 100vh;
  background-color: #f5f5f5;
}

.search-bar {
  display: flex;
  padding: 20rpx;
  background-color: #fff;
  
  input {
    flex: 1;
    height: 72rpx;
    padding: 0 24rpx;
    background-color: #f5f5f5;
    border-radius: 36rpx;
  }
  
  .search-btn {
    margin-left: 20rpx;
    padding: 0 24rpx;
    height: 72rpx;
    line-height: 72rpx;
    color: $primary-color;
  }
}

.filter-bar {
  display: flex;
  padding: 20rpx;
  background-color: #fff;
  border-top: 1rpx solid #eee;
  
  .filter-item {
    flex: 1;
    text-align: center;
    font-size: 28rpx;
    color: #666;
    
    &.active {
      color: $primary-color;
      font-weight: bold;
    }
    
    .arrow {
      margin-left: 4rpx;
    }
  }
}

.product-list {
  height: calc(100vh - 220rpx);
}

.product-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20rpx;
  padding: 20rpx;
}

.load-status {
  text-align: center;
  padding: 30rpx;
  color: #999;
  font-size: 24rpx;
}

.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 60rpx;
  
  text {
    margin-bottom: 20rpx;
    color: #999;
  }
}

.back-top {
  position: fixed;
  right: 30rpx;
  bottom: 200rpx;
  width: 88rpx;
  height: 88rpx;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  
  .iconfont {
    font-size: 40rpx;
    color: #666;
  }
}
</style>
```

---

## 9. 性能优化实战

### 9.1 分包加载

```json
// pages.json
{
  "pages": [
    { "path": "pages/index/index" },
    { "path": "pages/category/index" },
    { "path": "pages/cart/index" },
    { "path": "pages/user/index" },
    { "path": "pages/login/index" }
  ],
  "subPackages": [
    {
      "root": "packageProduct",
      "name": "product",
      "pages": [
        { "path": "pages/list/index" },
        { "path": "pages/detail/index" },
        { "path": "pages/search/index" }
      ]
    },
    {
      "root": "packageOrder",
      "name": "order",
      "pages": [
        { "path": "pages/list/index" },
        { "path": "pages/detail/index" },
        { "path": "pages/create/index" },
        { "path": "pages/pay/index" }
      ]
    },
    {
      "root": "packageUser",
      "name": "user",
      "pages": [
        { "path": "pages/profile/index" },
        { "path": "pages/address/list" },
        { "path": "pages/address/edit" },
        { "path": "pages/settings/index" }
      ]
    }
  ],
  "preloadRule": {
    "pages/index/index": {
      "network": "all",
      "packages": ["packageProduct"]
    },
    "pages/cart/index": {
      "network": "wifi",
      "packages": ["packageOrder"]
    },
    "pages/user/index": {
      "network": "wifi",
      "packages": ["packageUser"]
    }
  }
}
```

### 9.2 图片优化

```vue
<!-- components/base/LazyImage/LazyImage.vue -->
<template>
  <view class="lazy-image" :style="{ width, height }">
    <!-- 占位图 -->
    <view v-if="!loaded" class="lazy-image__placeholder">
      <image 
        v-if="placeholder" 
        :src="placeholder" 
        mode="aspectFill"
      />
      <view v-else class="lazy-image__skeleton"></view>
    </view>
    
    <!-- 实际图片 -->
    <image
      v-show="loaded"
      :src="src"
      :mode="mode"
      :lazy-load="true"
      :webp="webp"
      @load="handleLoad"
      @error="handleError"
    />
    
    <!-- 加载失败 -->
    <view v-if="error" class="lazy-image__error">
      <text class="iconfont icon-image-error"></text>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'

interface Props {
  src: string
  width?: string
  height?: string
  mode?: string
  placeholder?: string
  errorImage?: string
  webp?: boolean
  quality?: number
}

const props = withDefaults(defineProps<Props>(), {
  width: '100%',
  height: '100%',
  mode: 'aspectFill',
  webp: true,
  quality: 80
})

const loaded = ref(false)
const error = ref(false)

// 处理图片URL（添加CDN参数）
const processedSrc = computed(() => {
  if (!props.src) return ''
  
  // 添加图片处理参数
  const params = []
  
  // WebP格式
  if (props.webp) {
    params.push('format,webp')
  }
  
  // 图片质量
  if (props.quality && props.quality < 100) {
    params.push(`quality,q_${props.quality}`)
  }
  
  if (params.length > 0) {
    const connector = props.src.includes('?') ? '&' : '?'
    return `${props.src}${connector}x-oss-process=image/${params.join('/')}`
  }
  
  return props.src
})

// 监听src变化重置状态
watch(() => props.src, () => {
  loaded.value = false
  error.value = false
})

const handleLoad = () => {
  loaded.value = true
  error.value = false
}

const handleError = () => {
  loaded.value = false
  error.value = true
}
</script>

<style lang="scss">
.lazy-image {
  position: relative;
  overflow: hidden;
  
  image {
    width: 100%;
    height: 100%;
  }
  
  &__placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    
    image {
      width: 100%;
      height: 100%;
    }
  }
  
  &__skeleton {
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      #f0f0f0 25%,
      #e0e0e0 50%,
      #f0f0f0 75%
    );
    background-size: 200% 100%;
    animation: skeleton 1.5s infinite;
  }
  
  &__error {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f5f5f5;
    
    .iconfont {
      font-size: 48rpx;
      color: #ccc;
    }
  }
}

@keyframes skeleton {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
</style>
```

### 9.3 数据缓存策略

```typescript
// utils/cache.ts
interface CacheItem<T> {
  data: T
  timestamp: number
  ttl: number
}

class CacheManager {
  private prefix = 'app_cache_'
  private memoryCache = new Map<string, CacheItem<any>>()
  
  // 设置缓存
  set<T>(key: string, data: T, ttl = 5 * 60 * 1000): void {
    const cacheItem: CacheItem<T> = {
      data,
      timestamp: Date.now(),
      ttl
    }
    
    // 内存缓存
    this.memoryCache.set(key, cacheItem)
    
    // 持久化缓存
    try {
      uni.setStorageSync(this.prefix + key, JSON.stringify(cacheItem))
    } catch (error) {
      console.warn('缓存写入失败:', error)
    }
  }
  
  // 获取缓存
  get<T>(key: string): T | null {
    // 先检查内存缓存
    const memoryItem = this.memoryCache.get(key)
    if (memoryItem && !this.isExpired(memoryItem)) {
      return memoryItem.data
    }
    
    // 再检查持久化缓存
    try {
      const storageItem = uni.getStorageSync(this.prefix + key)
      if (storageItem) {
        const cacheItem: CacheItem<T> = JSON.parse(storageItem)
        
        if (!this.isExpired(cacheItem)) {
          // 写入内存缓存
          this.memoryCache.set(key, cacheItem)
          return cacheItem.data
        } else {
          // 已过期，删除
          this.remove(key)
        }
      }
    } catch (error) {
      console.warn('缓存读取失败:', error)
    }
    
    return null
  }
  
  // 删除缓存
  remove(key: string): void {
    this.memoryCache.delete(key)
    try {
      uni.removeStorageSync(this.prefix + key)
    } catch (error) {
      console.warn('缓存删除失败:', error)
    }
  }
  
  // 清空缓存
  clear(): void {
    this.memoryCache.clear()
    
    try {
      const keys = uni.getStorageInfoSync().keys
      keys.forEach(key => {
        if (key.startsWith(this.prefix)) {
          uni.removeStorageSync(key)
        }
      })
    } catch (error) {
      console.warn('缓存清空失败:', error)
    }
  }
  
  // 检查是否过期
  private isExpired(item: CacheItem<any>): boolean {
    return Date.now() - item.timestamp > item.ttl
  }
}

export const cache = new CacheManager()

// 带缓存的请求封装
export async function cachedRequest<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttl = 5 * 60 * 1000
): Promise<T> {
  // 先检查缓存
  const cached = cache.get<T>(key)
  if (cached !== null) {
    return cached
  }
  
  // 发起请求
  const data = await fetcher()
  
  // 写入缓存
  cache.set(key, data, ttl)
  
  return data
}
```

---

## 10. 多端适配实战

### 10.1 平台适配工具

```typescript
// utils/platform.ts
export type Platform = 'weixin' | 'dingtalk' | 'alipay' | 'h5' | 'app' | 'unknown'

// 获取当前平台
export const getPlatform = (): Platform => {
  // #ifdef MP-WEIXIN
  return 'weixin'
  // #endif
  
  // #ifdef MP-DINGTALK
  return 'dingtalk'
  // #endif
  
  // #ifdef MP-ALIPAY
  return 'alipay'
  // #endif
  
  // #ifdef H5
  return 'h5'
  // #endif
  
  // #ifdef APP-PLUS
  return 'app'
  // #endif
  
  return 'unknown'
}

// 平台特性检测
export const platformFeatures = {
  // 是否支持手机号登录
  canGetPhoneNumber: () => {
    const platform = getPlatform()
    return ['weixin', 'dingtalk'].includes(platform)
  },
  
  // 是否支持扫码
  canScan: () => {
    const platform = getPlatform()
    return ['weixin', 'dingtalk', 'alipay', 'app'].includes(platform)
  },
  
  // 是否支持支付
  canPay: () => {
    const platform = getPlatform()
    return ['weixin', 'alipay', 'app'].includes(platform)
  },
  
  // 是否支持分享
  canShare: () => {
    const platform = getPlatform()
    return ['weixin', 'dingtalk'].includes(platform)
  }
}

// 统一接口封装
export const platformApi = {
  // 登录
  login: async (): Promise<{ code: string; platform: Platform }> => {
    const platform = getPlatform()
    
    return new Promise((resolve, reject) => {
      switch (platform) {
        case 'weixin':
          uni.login({
            provider: 'weixin',
            success: (res) => resolve({ code: res.code, platform }),
            fail: reject
          })
          break
          
        case 'dingtalk':
          // @ts-ignore
          dd.getAuthCode({
            success: (res: any) => resolve({ code: res.authCode, platform }),
            fail: reject
          })
          break
          
        default:
          reject(new Error(`Platform ${platform} not supported`))
      }
    })
  },
  
  // 扫码
  scan: async (): Promise<string> => {
    const platform = getPlatform()
    
    return new Promise((resolve, reject) => {
      switch (platform) {
        case 'weixin':
        case 'alipay':
        case 'app':
          uni.scanCode({
            success: (res) => resolve(res.result),
            fail: reject
          })
          break
          
        case 'dingtalk':
          // @ts-ignore
          dd.scan({
            type: 'qr',
            success: (res: any) => resolve(res.text),
            fail: reject
          })
          break
          
        default:
          reject(new Error(`Platform ${platform} not supported`))
      }
    })
  },
  
  // 分享
  share: async (options: {
    title: string
    path?: string
    imageUrl?: string
  }): Promise<void> => {
    const platform = getPlatform()
    
    return new Promise((resolve, reject) => {
      switch (platform) {
        case 'weixin':
          // 微信通过onShareAppMessage配置
          resolve()
          break
          
        case 'dingtalk':
          // @ts-ignore
          dd.share({
            type: 0,
            title: options.title,
            url: options.path,
            image: options.imageUrl,
            success: () => resolve(),
            fail: reject
          })
          break
          
        default:
          reject(new Error(`Platform ${platform} not supported`))
      }
    })
  }
}
```

### 10.2 样式适配

```scss
// styles/platform.scss

// 平台变量
$platform-weixin: '.platform-weixin';
$platform-dingtalk: '.platform-dingtalk';
$platform-h5: '.platform-h5';

// 安全区域
@mixin safe-area-bottom($property: padding-bottom, $extra: 0) {
  #{$property}: #{$extra};
  #{$property}: calc(#{$extra} + constant(safe-area-inset-bottom));
  #{$property}: calc(#{$extra} + env(safe-area-inset-bottom));
}

@mixin safe-area-top($property: padding-top, $extra: 0) {
  #{$property}: #{$extra};
  #{$property}: calc(#{$extra} + constant(safe-area-inset-top));
  #{$property}: calc(#{$extra} + env(safe-area-inset-top));
}

// 响应式字体
@mixin responsive-font($min, $max, $minVw: 320, $maxVw: 750) {
  font-size: $min;
  @media screen and (min-width: #{$minVw}px) {
    font-size: calc(#{$min} + (#{$max} - #{$min}) * ((100vw - #{$minVw}px) / (#{$maxVw} - #{$minVw})));
  }
  @media screen and (min-width: #{$maxVw}px) {
    font-size: $max;
  }
}

// 多行文本截断
@mixin text-ellipsis($lines: 1) {
  @if $lines == 1 {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  } @else {
    display: -webkit-box;
    -webkit-line-clamp: $lines;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
}

// 1px边框
@mixin border-1px($color: #eee, $position: bottom) {
  position: relative;
  
  &::after {
    content: '';
    position: absolute;
    
    @if $position == bottom {
      left: 0;
      bottom: 0;
      width: 100%;
      height: 1px;
      background-color: $color;
      transform: scaleY(0.5);
    }
    
    @if $position == top {
      left: 0;
      top: 0;
      width: 100%;
      height: 1px;
      background-color: $color;
      transform: scaleY(0.5);
    }
    
    @if $position == left {
      left: 0;
      top: 0;
      width: 1px;
      height: 100%;
      background-color: $color;
      transform: scaleX(0.5);
    }
    
    @if $position == right {
      right: 0;
      top: 0;
      width: 1px;
      height: 100%;
      background-color: $color;
      transform: scaleX(0.5);
    }
  }
}
```

---

## 11. 错误处理与监控

### 11.1 全局错误处理

```typescript
// utils/errorHandler.ts
interface ErrorInfo {
  type: 'js' | 'api' | 'resource' | 'promise'
  message: string
  stack?: string
  url?: string
  line?: number
  column?: number
  timestamp: number
  userInfo?: any
  deviceInfo?: any
  pageInfo?: {
    path: string
    options: Record<string, string>
  }
}

class ErrorHandler {
  private errors: ErrorInfo[] = []
  private maxErrors = 100
  private reportUrl = ''
  
  constructor() {
    this.init()
  }
  
  private init() {
    // 全局错误监听
    // #ifdef H5
    window.onerror = (message, source, line, column, error) => {
      this.captureError({
        type: 'js',
        message: String(message),
        stack: error?.stack,
        url: source,
        line,
        column
      })
      return true
    }
    
    window.addEventListener('unhandledrejection', (event) => {
      this.captureError({
        type: 'promise',
        message: event.reason?.message || String(event.reason),
        stack: event.reason?.stack
      })
    })
    // #endif
  }
  
  // 捕获错误
  captureError(error: Partial<ErrorInfo>) {
    const errorInfo: ErrorInfo = {
      type: error.type || 'js',
      message: error.message || 'Unknown error',
      stack: error.stack,
      url: error.url,
      line: error.line,
      column: error.column,
      timestamp: Date.now(),
      userInfo: this.getUserInfo(),
      deviceInfo: this.getDeviceInfo(),
      pageInfo: this.getPageInfo()
    }
    
    // 存储错误
    this.errors.push(errorInfo)
    if (this.errors.length > this.maxErrors) {
      this.errors.shift()
    }
    
    // 上报错误
    this.reportError(errorInfo)
    
    // 控制台输出
    if (__DEV__) {
      console.error('[ErrorHandler]', errorInfo)
    }
  }
  
  // 上报错误
  private reportError(error: ErrorInfo) {
    if (!this.reportUrl) return
    
    try {
      uni.request({
        url: this.reportUrl,
        method: 'POST',
        data: error,
        fail: () => {
          // 上报失败，存储到本地
          this.saveToLocal(error)
        }
      })
    } catch (e) {
      console.warn('错误上报失败:', e)
    }
  }
  
  // 保存到本地
  private saveToLocal(error: ErrorInfo) {
    try {
      const errors = uni.getStorageSync('error_logs') || []
      errors.push(error)
      if (errors.length > 50) {
        errors.shift()
      }
      uni.setStorageSync('error_logs', errors)
    } catch (e) {
      console.warn('错误日志保存失败:', e)
    }
  }
  
  // 获取用户信息
  private getUserInfo() {
    try {
      return uni.getStorageSync('userInfo')
    } catch {
      return null
    }
  }
  
  // 获取设备信息
  private getDeviceInfo() {
    try {
      return uni.getSystemInfoSync()
    } catch {
      return null
    }
  }
  
  // 获取页面信息
  private getPageInfo() {
    try {
      const pages = getCurrentPages()
      const currentPage = pages[pages.length - 1]
      if (currentPage) {
        return {
          path: currentPage.route || '',
          options: currentPage.options || {}
        }
      }
    } catch {
      return undefined
    }
  }
  
  // 设置上报地址
  setReportUrl(url: string) {
    this.reportUrl = url
  }
  
  // 获取所有错误
  getErrors() {
    return this.errors
  }
  
  // 清空错误
  clearErrors() {
    this.errors = []
  }
}

export const errorHandler = new ErrorHandler()

// API错误处理
export function handleApiError(error: any, options?: { silent?: boolean }) {
  const message = error.message || '请求失败'
  
  errorHandler.captureError({
    type: 'api',
    message,
    stack: error.stack
  })
  
  if (!options?.silent) {
    uni.showToast({
      title: message,
      icon: 'none'
    })
  }
}
```

### 11.2 性能监控

```typescript
// utils/performance.ts
interface PerformanceMetric {
  name: string
  value: number
  timestamp: number
  extra?: Record<string, any>
}

class PerformanceMonitor {
  private metrics: PerformanceMetric[] = []
  private pageLoadTimes = new Map<string, number>()
  
  // 记录页面加载开始
  markPageLoadStart(pagePath: string) {
    this.pageLoadTimes.set(pagePath, Date.now())
  }
  
  // 记录页面加载完成
  markPageLoadEnd(pagePath: string) {
    const startTime = this.pageLoadTimes.get(pagePath)
    if (startTime) {
      const loadTime = Date.now() - startTime
      this.recordMetric('pageLoad', loadTime, { pagePath })
      this.pageLoadTimes.delete(pagePath)
    }
  }
  
  // 记录API请求时间
  recordApiTime(url: string, duration: number, success: boolean) {
    this.recordMetric('apiRequest', duration, { url, success })
  }
  
  // 记录指标
  recordMetric(name: string, value: number, extra?: Record<string, any>) {
    const metric: PerformanceMetric = {
      name,
      value,
      timestamp: Date.now(),
      extra
    }
    
    this.metrics.push(metric)
    
    // 定期上报
    if (this.metrics.length >= 10) {
      this.report()
    }
  }
  
  // 上报性能数据
  private report() {
    if (this.metrics.length === 0) return
    
    const metricsToReport = [...this.metrics]
    this.metrics = []
    
    // 上报到后端
    uni.request({
      url: '/api/performance/report',
      method: 'POST',
      data: {
        metrics: metricsToReport,
        deviceInfo: uni.getSystemInfoSync()
      }
    })
  }
  
  // 获取性能报告
  getReport() {
    const report: Record<string, { count: number; avg: number; max: number; min: number }> = {}
    
    this.metrics.forEach(metric => {
      if (!report[metric.name]) {
        report[metric.name] = {
          count: 0,
          avg: 0,
          max: -Infinity,
          min: Infinity
        }
      }
      
      const item = report[metric.name]
      item.count++
      item.avg = (item.avg * (item.count - 1) + metric.value) / item.count
      item.max = Math.max(item.max, metric.value)
      item.min = Math.min(item.min, metric.value)
    })
    
    return report
  }
}

export const performanceMonitor = new PerformanceMonitor()
```

---

## 12. 安全最佳实践

### 12.1 敏感数据处理

```typescript
// utils/security.ts
import CryptoJS from 'crypto-js'

// AES加密
export function encrypt(data: string, key: string): string {
  return CryptoJS.AES.encrypt(data, key).toString()
}

// AES解密
export function decrypt(ciphertext: string, key: string): string {
  const bytes = CryptoJS.AES.decrypt(ciphertext, key)
  return bytes.toString(CryptoJS.enc.Utf8)
}

// 手机号脱敏
export function maskPhone(phone: string): string {
  if (!phone || phone.length < 11) return phone
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}

// 身份证脱敏
export function maskIdCard(idCard: string): string {
  if (!idCard || idCard.length < 15) return idCard
  return idCard.replace(/(\d{4})\d+(\d{4})/, '$1**********$2')
}

// 银行卡脱敏
export function maskBankCard(card: string): string {
  if (!card || card.length < 8) return card
  return card.replace(/(\d{4})\d+(\d{4})/, '$1 **** **** $2')
}

// 姓名脱敏
export function maskName(name: string): string {
  if (!name) return ''
  if (name.length <= 1) return '*'
  if (name.length === 2) return name[0] + '*'
  return name[0] + '*'.repeat(name.length - 2) + name[name.length - 1]
}

// 生成请求签名
export function generateSign(params: Record<string, any>, secret: string): string {
  // 1. 参数排序
  const sortedKeys = Object.keys(params).sort()
  
  // 2. 拼接参数
  const paramStr = sortedKeys
    .filter(key => params[key] !== undefined && params[key] !== null)
    .map(key => `${key}=${params[key]}`)
    .join('&')
  
  // 3. 加上密钥
  const signStr = paramStr + '&key=' + secret
  
  // 4. MD5签名
  return CryptoJS.MD5(signStr).toString().toUpperCase()
}

// 验证签名
export function verifySign(params: Record<string, any>, sign: string, secret: string): boolean {
  const { sign: _, ...restParams } = params
  const calculatedSign = generateSign(restParams, secret)
  return calculatedSign === sign
}
```

### 12.2 输入验证

```typescript
// utils/validator.ts
export const validators = {
  // 手机号
  phone: (value: string) => /^1[3-9]\d{9}$/.test(value),
  
  // 邮箱
  email: (value: string) => /^[\w.-]+@[\w.-]+\.\w+$/.test(value),
  
  // 身份证
  idCard: (value: string) => {
    if (!/^\d{17}[\dXx]$/.test(value)) return false
    
    // 校验码验证
    const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2]
    const checkCodes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2']
    
    let sum = 0
    for (let i = 0; i < 17; i++) {
      sum += parseInt(value[i]) * weights[i]
    }
    
    return checkCodes[sum % 11] === value[17].toUpperCase()
  },
  
  // 银行卡号（Luhn算法）
  bankCard: (value: string) => {
    if (!/^\d{16,19}$/.test(value)) return false
    
    let sum = 0
    let shouldDouble = false
    
    for (let i = value.length - 1; i >= 0; i--) {
      let digit = parseInt(value[i])
      
      if (shouldDouble) {
        digit *= 2
        if (digit > 9) digit -= 9
      }
      
      sum += digit
      shouldDouble = !shouldDouble
    }
    
    return sum % 10 === 0
  },
  
  // 密码强度
  passwordStrength: (value: string) => {
    let strength = 0
    
    if (value.length >= 8) strength++
    if (value.length >= 12) strength++
    if (/[a-z]/.test(value)) strength++
    if (/[A-Z]/.test(value)) strength++
    if (/[0-9]/.test(value)) strength++
    if (/[!@#$%^&*]/.test(value)) strength++
    
    return strength // 0-6
  },
  
  // URL
  url: (value: string) => {
    try {
      new URL(value)
      return true
    } catch {
      return false
    }
  },
  
  // XSS过滤
  sanitize: (value: string) => {
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#x27;')
      .replace(/\//g, '&#x2F;')
  }
}
```

---

## 13. 测试策略

### 13.1 单元测试

```typescript
// tests/utils/validator.test.ts
import { describe, it, expect } from 'vitest'
import { validators } from '@/utils/validator'

describe('validators', () => {
  describe('phone', () => {
    it('should validate correct phone number', () => {
      expect(validators.phone('13800138000')).toBe(true)
      expect(validators.phone('19912345678')).toBe(true)
    })
    
    it('should reject invalid phone number', () => {
      expect(validators.phone('12345678901')).toBe(false)
      expect(validators.phone('1380013800')).toBe(false)
      expect(validators.phone('abc')).toBe(false)
    })
  })
  
  describe('email', () => {
    it('should validate correct email', () => {
      expect(validators.email('test@example.com')).toBe(true)
      expect(validators.email('user.name@domain.co')).toBe(true)
    })
    
    it('should reject invalid email', () => {
      expect(validators.email('invalid')).toBe(false)
      expect(validators.email('@example.com')).toBe(false)
    })
  })
  
  describe('idCard', () => {
    it('should validate correct ID card', () => {
      expect(validators.idCard('110101199003074518')).toBe(true)
    })
    
    it('should reject invalid ID card', () => {
      expect(validators.idCard('110101199003074519')).toBe(false)
    })
  })
})
```

### 13.2 组件测试

```typescript
// tests/components/Button.test.ts
import { describe, it, expect, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import Button from '@/components/base/Button/Button.vue'

describe('Button', () => {
  it('should render slot content', () => {
    const wrapper = mount(Button, {
      slots: {
        default: '按钮文字'
      }
    })
    expect(wrapper.text()).toContain('按钮文字')
  })
  
  it('should apply type class', () => {
    const wrapper = mount(Button, {
      props: { type: 'primary' }
    })
    expect(wrapper.classes()).toContain('custom-button--primary')
  })
  
  it('should emit click event', async () => {
    const wrapper = mount(Button)
    await wrapper.trigger('click')
    expect(wrapper.emitted('click')).toBeTruthy()
  })
  
  it('should not emit click when disabled', async () => {
    const wrapper = mount(Button, {
      props: { disabled: true }
    })
    await wrapper.trigger('click')
    expect(wrapper.emitted('click')).toBeFalsy()
  })
  
  it('should show loading state', () => {
    const wrapper = mount(Button, {
      props: { loading: true }
    })
    expect(wrapper.classes()).toContain('custom-button--loading')
  })
})
```

---

## 14. CI/CD与发布流程

### 14.1 GitHub Actions配置

```yaml
# .github/workflows/ci.yml
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run test
      
  build:
    needs: [lint, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm run build:mp-weixin
      - uses: actions/upload-artifact@v3
        with:
          name: weapp-dist
          path: dist/build/mp-weixin
          
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: weapp-dist
          path: dist
      - name: Deploy to WeChat
        run: |
          npx miniprogram-ci upload \
            --pp ./dist \
            --pkp "${{ secrets.WX_PRIVATE_KEY }}" \
            --appid ${{ secrets.WX_APPID }} \
            --uv ${{ github.sha }}
```

### 14.2 版本管理

```json
// package.json
{
  "scripts": {
    "release": "standard-version",
    "release:minor": "standard-version --release-as minor",
    "release:major": "standard-version --release-as major",
    "release:patch": "standard-version --release-as patch"
  }
}
```

```javascript
// .versionrc.js
module.exports = {
  types: [
    { type: 'feat', section: '✨ 新功能' },
    { type: 'fix', section: '🐛 Bug修复' },
    { type: 'perf', section: '⚡ 性能优化' },
    { type: 'refactor', section: '♻️ 代码重构' },
    { type: 'docs', section: '📝 文档更新', hidden: true },
    { type: 'style', section: '💄 样式调整', hidden: true },
    { type: 'test', section: '✅ 测试', hidden: true },
    { type: 'chore', section: '🔧 构建/工具', hidden: true }
  ]
}
```

---

## 15. 实战案例：电商小程序

### 15.1 项目结构

```
src/
├── pages/
│   ├── index/              # 首页
│   ├── category/           # 分类
│   ├── cart/               # 购物车
│   ├── user/               # 用户中心
│   └── login/              # 登录
├── packageProduct/
│   └── pages/
│       ├── list/           # 商品列表
│       ├── detail/         # 商品详情
│       └── search/         # 搜索
├── packageOrder/
│   └── pages/
│       ├── create/         # 创建订单
│       ├── list/           # 订单列表
│       ├── detail/         # 订单详情
│       └── pay/            # 支付
├── packageUser/
│   └── pages/
│       ├── profile/        # 个人信息
│       ├── address/        # 地址管理
│       ├── coupon/         # 优惠券
│       └── settings/       # 设置
```

### 15.2 核心功能

- **首页**：轮播图、分类入口、推荐商品、活动专区
- **商品**：列表筛选、详情、规格选择、加入购物车
- **购物车**：数量修改、选中/全选、价格计算、结算
- **订单**：创建订单、支付、订单列表、订单详情
- **用户**：登录/注册、个人信息、地址管理、优惠券

---

## 16. 实战案例：企业OA小程序

### 16.1 项目结构（钉钉小程序）

```
src/
├── pages/
│   ├── workbench/          # 工作台
│   ├── message/            # 消息
│   ├── contacts/           # 通讯录
│   └── mine/               # 我的
├── packageApproval/
│   └── pages/
│       ├── list/           # 审批列表
│       ├── detail/         # 审批详情
│       ├── apply/          # 发起审批
│       └── form/           # 审批表单
├── packageAttendance/
│   └── pages/
│       ├── clock/          # 打卡
│       ├── record/         # 考勤记录
│       └── leave/          # 请假
├── packageTask/
│   └── pages/
│       ├── list/           # 任务列表
│       ├── detail/         # 任务详情
│       └── create/         # 创建任务
```

### 16.2 核心功能

- **工作台**：快捷入口、待办事项、公告通知
- **审批**：发起审批、审批列表、审批处理
- **考勤**：定位打卡、考勤统计、请假申请
- **任务**：任务创建、任务分配、进度跟踪
- **通讯录**：组织架构、人员搜索、部门联系人

---

本文档涵盖了企业级小程序开发的核心知识点和最佳实践，包括架构设计、代码规范、权限体系、网络请求、状态管理、组件封装、表单处理、列表分页、性能优化、多端适配、错误监控、安全实践、测试策略和CI/CD流程等内容。这些经验和模式可以直接应用于大厂项目的实际开发中。
